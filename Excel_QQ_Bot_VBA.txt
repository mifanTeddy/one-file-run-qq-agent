' ===============================================
' QQæœºå™¨äºº Excel VBA å®Œæ•´å®ç°
' ===============================================

' ===== æ¨¡å—1: HTTPHelper =====
' é€šç”¨HTTPè¯·æ±‚æ¨¡å—

Option Explicit

' é€šç”¨HTTPè¯·æ±‚å‡½æ•°
Public Function HttpRequest(url As String, method As String, Optional jsonData As String = "", Optional headers As Object = Nothing) As String
    Dim http As Object
    Set http = CreateObject("MSXML2.XMLHTTP")

    On Error GoTo ErrorHandler

    ' é…ç½®è¯·æ±‚
    http.Open method, url, False
    http.setTimeOut 30000 ' 30ç§’è¶…æ—¶

    ' è®¾ç½®é»˜è®¤å¤´éƒ¨
    If method = "POST" Then
        http.setRequestHeader "Content-Type", "application/json"
    End If

    ' è®¾ç½®è‡ªå®šä¹‰å¤´éƒ¨
    If Not headers Is Nothing Then
        Dim key As Variant
        For Each key In headers.Keys
            http.setRequestHeader CStr(key), CStr(headers(key))
        Next key
    End If

    ' å‘é€è¯·æ±‚
    If jsonData <> "" Then
        http.send jsonData
    Else
        http.send
    End If

    ' æ£€æŸ¥å“åº”çŠ¶æ€
    If http.Status = 200 Then
        HttpRequest = http.responseText
    Else
        LogMessage "HTTPé”™è¯¯", "Status: " & http.Status & " - " & http.statusText
        HttpRequest = ""
    End If

    Set http = Nothing
    Exit Function

ErrorHandler:
    LogMessage "HTTPå¼‚å¸¸", Err.Description
    HttpRequest = ""
    Set http = Nothing
End Function

' è·å–ç¾¤æ¶ˆæ¯
Public Function GetMessages(napcatUrl As String, groupId As String) As String
    Dim jsonData As String
    jsonData = "{""group_id"": " & groupId & ", ""count"": 40}"
    GetMessages = HttpRequest(napcatUrl & "/get_group_msg_history", "POST", jsonData)
End Function

' å‘é€ç¾¤æ¶ˆæ¯
Public Function SendMessage(napcatUrl As String, groupId As String, message As String) As String
    Dim jsonData As String
    message = Replace(message, """", "\""") ' è½¬ä¹‰å¼•å·
    jsonData = "{""group_id"": " & groupId & ", ""message"": """ & message & """}"
    SendMessage = HttpRequest(napcatUrl & "/send_group_msg", "POST", jsonData)
End Function

' è°ƒç”¨Gemini API
Public Function CallGeminiAPI(apiUrl As String, apiKey As String, prompt As String) As String
    Dim headers As Object
    Set headers = CreateObject("Scripting.Dictionary")
    headers.Add "x-goog-api-key", apiKey

    Dim jsonData As String
    jsonData = BuildGeminiPayload(prompt)

    CallGeminiAPI = HttpRequest(apiUrl, "POST", jsonData, headers)
End Function

' ===== æ¨¡å—2: JSONHelper =====
' JSONè§£æå’Œæ„å»ºæ¨¡å—

Option Explicit

' æå–JSONå­—ç¬¦ä¸²å€¼ï¼ˆç®€å•å®ç°ï¼‰
Public Function GetJsonValue(jsonText As String, key As String) As String
    Dim pattern As String
    Dim startPos As Long, endPos As Long
    Dim result As String

    ' æŸ¥æ‰¾ "key": "value" æˆ– "key": value æ¨¡å¼
    pattern = """" & key & """:"
    startPos = InStr(jsonText, pattern)

    If startPos > 0 Then
        startPos = startPos + Len(pattern)

        ' è·³è¿‡ç©ºæ ¼
        While Mid(jsonText, startPos, 1) = " " And startPos <= Len(jsonText)
            startPos = startPos + 1
        Wend

        If Mid(jsonText, startPos, 1) = """" Then
            ' å­—ç¬¦ä¸²å€¼
            startPos = startPos + 1
            endPos = InStr(startPos, jsonText, """")
            If endPos > startPos Then
                result = Mid(jsonText, startPos, endPos - startPos)
            End If
        Else
            ' æ•°å€¼æˆ–å…¶ä»–
            endPos = InStr(startPos, jsonText, ",")
            If endPos = 0 Then endPos = InStr(startPos, jsonText, "}")
            If endPos > startPos Then
                result = Trim(Mid(jsonText, startPos, endPos - startPos))
            End If
        End If
    End If

    GetJsonValue = result
End Function

' æå–æ¶ˆæ¯æ•°ç»„
Public Function ParseMessages(jsonResponse As String) As Collection
    Dim messages As New Collection
    Dim startPos As Long, endPos As Long
    Dim messageJson As String

    ' æŸ¥æ‰¾ "messages": [...]
    startPos = InStr(jsonResponse, """messages"":")
    If startPos = 0 Then Exit Function

    startPos = InStr(startPos, jsonResponse, "[")
    If startPos = 0 Then Exit Function

    startPos = startPos + 1

    ' ç®€åŒ–ï¼šæŒ‰ }, { åˆ†å‰²æ¶ˆæ¯ï¼ˆä¸å®Œç¾ä½†å®ç”¨ï¼‰
    Do
        endPos = InStr(startPos, jsonResponse, "},{")
        If endPos = 0 Then
            endPos = InStr(startPos, jsonResponse, "}]")
            If endPos = 0 Then Exit Do
        End If

        messageJson = Mid(jsonResponse, startPos, endPos - startPos + 1)

        ' æå–æ¶ˆæ¯ä¿¡æ¯
        Dim msgTime As String, userId As String, rawMessage As String
        msgTime = GetJsonValue(messageJson, "time")
        userId = GetJsonValue(messageJson, "user_id")
        rawMessage = GetJsonValue(messageJson, "raw_message")

        If msgTime <> "" And userId <> "" Then
            Dim msgDict As Object
            Set msgDict = CreateObject("Scripting.Dictionary")
            msgDict.Add "time", CLng(msgTime)
            msgDict.Add "user_id", userId
            msgDict.Add "raw_message", rawMessage
            messages.Add msgDict
        End If

        startPos = endPos + 2
        If InStr(startPos, jsonResponse, "}]") < startPos + 10 Then Exit Do

    Loop While startPos < Len(jsonResponse)

    Set ParseMessages = messages
End Function

' æ„å»ºGemini APIè½½è·
Public Function BuildGeminiPayload(prompt As String) As String
    Dim systemPrompt As String
    systemPrompt = "ç°åœ¨ä½ ä¸å†æ˜¯ä¸ªAIåŠ©ç†ï¼Œæ²¡å¿…è¦å¸®åŠ©ç”¨æˆ·è§£å†³ä»»ä½•é—®é¢˜,ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸€ä½å«åšæ¥ æ¥ çš„å°‘ç”·"

    ' è½¬ä¹‰JSONå­—ç¬¦ä¸²
    prompt = Replace(prompt, """", "\""")
    prompt = Replace(prompt, vbLf, "\n")
    systemPrompt = Replace(systemPrompt, """", "\""")

    BuildGeminiPayload = "{" & _
        """contents"": [{" & _
            """role"": ""user""," & _
            """parts"": [{" & _
                """text"": ""ç³»ç»ŸæŒ‡ä»¤: " & systemPrompt & "\n\nç”¨æˆ·æ¶ˆæ¯: " & prompt & """" & _
            "}]" & _
        "}]," & _
        """tools"": [{" & _
            """functionDeclarations"": [" & _
                "{""name"": ""send_group_message"", ""description"": ""å‘é€æ¶ˆæ¯åˆ°QQç¾¤"", ""parameters"": {""type"": ""object"", ""properties"": {""message"": {""type"": ""string"", ""description"": ""è¦å‘é€çš„æ¶ˆæ¯å†…å®¹""}}, ""required"": [""message""]}}," & _
                "{""name"": ""end"", ""description"": ""ç»“æŸå¯¹è¯"", ""parameters"": {""type"": ""object"", ""properties"": {""reason"": {""type"": ""string"", ""description"": ""ç»“æŸåŸå› ""}}, ""required"": [""reason""]}}" & _
            "]" & _
        "}]" & _
    "}"
End Function

' ===== æ¨¡å—3: MessageProcessor =====
' æ¶ˆæ¯è·å–å’Œå¤„ç†æ¨¡å—

Option Explicit

Private lastMessageTime As Long

' ä¸»æ¶ˆæ¯å¤„ç†å‡½æ•°
Public Sub ProcessNewMessages()
    Dim config As Object
    Set config = GetConfig() ' ä»Configå·¥ä½œè¡¨è·å–é…ç½®

    ' è·å–ç¾¤æ¶ˆæ¯
    Dim response As String
    response = GetMessages(config("NAPCAT_URL"), config("GROUP_ID"))

    If response = "" Then
        LogMessage "é”™è¯¯", "æ— æ³•è·å–æ¶ˆæ¯"
        Exit Sub
    End If

    ' æ£€æŸ¥å“åº”çŠ¶æ€
    Dim status As String
    status = GetJsonValue(response, "status")

    If status <> "ok" Then
        LogMessage "é”™è¯¯", "APIè¿”å›çŠ¶æ€: " & status
        Exit Sub
    End If

    ' è§£ææ¶ˆæ¯
    Dim messages As Collection
    Set messages = ParseMessages(response)

    If messages.Count = 0 Then Exit Sub

    ' æ£€æµ‹æ–°æ¶ˆæ¯
    Dim newMessages As Collection
    Set newMessages = DetectNewMessages(messages, config("BOT_QQ"))

    If newMessages.Count > 0 Then
        ' æ ¼å¼åŒ–æ¶ˆæ¯å†å²
        Dim chatHistory As String
        chatHistory = FormatMessageHistory(messages, config("BOT_QQ"))

        ' æ ¼å¼åŒ–æ–°æ¶ˆæ¯
        Dim newMessageText As String
        newMessageText = FormatNewMessages(newMessages)

        ' æ„å»ºAIæç¤ºè¯
        Dim prompt As String
        prompt = BuildPrompt(chatHistory, newMessageText, config)

        LogMessage "å¤„ç†", "æ£€æµ‹åˆ° " & newMessages.Count & " æ¡æ–°æ¶ˆæ¯"

        ' è°ƒç”¨AIå¤„ç†
        CallAIForProcessing prompt, config
    End If
End Sub

' æ£€æµ‹æ–°æ¶ˆæ¯
Private Function DetectNewMessages(messages As Collection, botQQ As String) As Collection
    Dim newMessages As New Collection
    Dim msg As Object
    Dim msgTime As Long

    For Each msg In messages
        msgTime = CLng(msg("time"))

        ' è¿‡æ»¤æœºå™¨äººè‡ªå·±çš„æ¶ˆæ¯å’Œæ—§æ¶ˆæ¯
        If msg("user_id") <> botQQ And msgTime > lastMessageTime Then
            newMessages.Add msg

            ' æ›´æ–°æœ€æ–°æ¶ˆæ¯æ—¶é—´
            If msgTime > lastMessageTime Then
                lastMessageTime = msgTime
                ' ä¿å­˜åˆ°é…ç½®
                SaveLastMessageTime msgTime
            End If
        End If
    Next msg

    Set DetectNewMessages = newMessages
End Function

' æ ¼å¼åŒ–æ¶ˆæ¯å†å²
Private Function FormatMessageHistory(messages As Collection, botQQ As String) As String
    Dim result As String
    Dim msg As Object
    Dim timeStr As String, tag As String

    For Each msg In messages
        timeStr = Format(DateAdd("s", CLng(msg("time")) - CLng(msg("time")) \ 86400 * 86400, "00:00:00"), "hh:mm:ss")

        tag = ""
        If msg("user_id") = botQQ Then
            tag = "[æˆ‘è‡ªå·±]"
        End If

        result = result & "[" & timeStr & "] ç”¨æˆ·" & msg("user_id") & tag & ": " & msg("raw_message") & vbLf
    Next msg

    FormatMessageHistory = result
End Function

' æ ¼å¼åŒ–æ–°æ¶ˆæ¯
Private Function FormatNewMessages(newMessages As Collection) As String
    Dim result As String
    Dim msg As Object
    Dim timeStr As String

    For Each msg In newMessages
        timeStr = Format(DateAdd("s", CLng(msg("time")) - CLng(msg("time")) \ 86400 * 86400, "00:00:00"), "hh:mm:ss")
        result = result & "[" & timeStr & "] ç”¨æˆ·" & msg("user_id") & ": " & msg("raw_message") & vbLf

        LogMessage "æ–°æ¶ˆæ¯", msg("raw_message")
    Next msg

    FormatNewMessages = result
End Function

' æ„å»ºAIæç¤ºè¯
Private Function BuildPrompt(chatHistory As String, newMessages As String, config As Object) As String
    Dim currentTime As String
    currentTime = Format(Now, "yyyy-mm-dd hh:mm:ss")

    BuildPrompt = "å½“å‰æ—¶é—´: " & currentTime & vbLf & _
        "ç¾¤èŠID: " & config("GROUP_ID") & vbLf & _
        "æˆ‘çš„QQå·: " & config("BOT_QQ") & vbLf & vbLf & _
        "ğŸ’¬ ç¾¤èŠå†å²è®°å½•:" & vbLf & _
        chatHistory & vbLf & _
        "------ ä»¥ä¸‹æ˜¯æ–°æ¶ˆæ¯ ------" & vbLf & _
        newMessages & _
        "------ ä»¥ä¸Šæ˜¯æ‰€æœ‰æ–°æ¶ˆæ¯å†…å®¹ ------" & vbLf & vbLf & _
        "ğŸ§  è¯·ä»”ç»†åˆ†æå½“å‰å¯¹è¯çŠ¶æ€ï¼Œç„¶åå†³å®šä¸‹ä¸€æ­¥æ“ä½œ:" & vbLf & vbLf & _
        "1. å‚ä¸åˆ¤æ–­ - æ˜¯å¦éœ€è¦å›å¤:" & vbLf & _
        "   - æ¶ˆæ¯æ˜¯å¦ä¸æˆ‘ç›¸å…³æˆ–å€¼å¾—å‚ä¸ï¼Ÿ" & vbLf & _
        "   - å¦‚æœè¯é¢˜æ— èŠä¸”æ— æ³•å¼€æ¶®ç¾¤å‹ï¼Œç›´æ¥è°ƒç”¨endå·¥å…·" & vbLf & _
        "   - å¦‚æœå€¼å¾—åæ§½æˆ–æœ‰è¶£ï¼Œç”¨send_group_messageç®€çŸ­å›å¤" & vbLf & vbLf & _
        "2. å›å¤é£æ ¼:" & vbLf & _
        "   - ç®€æ´å›å¤ï¼Œå°½é‡20å­—ä»¥å†…" & vbLf & _
        "   - å¤šç”¨åæ§½ï¼Œå°‘ç”¨è§£é‡Š" & vbLf & _
        "   - åƒçœŸå®çš„23å²ç½‘å‹ä¸€æ ·è¯´è¯" & vbLf & vbLf & _
        "è®°ä½ï¼šç»ä¸ç›´æ¥è¿”å›æ–‡æœ¬ï¼Œå¿…é¡»ä½¿ç”¨send_group_messageæˆ–endå·¥å…·ï¼"
End Function

' åˆå§‹åŒ–ï¼ˆä»é…ç½®åŠ è½½æœ€åæ¶ˆæ¯æ—¶é—´ï¼‰
Public Sub InitializeLastMessageTime()
    lastMessageTime = GetConfigValue("LAST_MESSAGE_TIME", 0)
End Sub

' ä¿å­˜æœ€åæ¶ˆæ¯æ—¶é—´
Private Sub SaveLastMessageTime(msgTime As Long)
    SaveConfigValue "LAST_MESSAGE_TIME", msgTime
End Sub

' ===== æ¨¡å—4: AIProcessor =====
' AIè°ƒç”¨å’Œå“åº”è§£ææ¨¡å—

Option Explicit

' è°ƒç”¨AIå¤„ç†æ¶ˆæ¯
Public Sub CallAIForProcessing(prompt As String, config As Object)
    LogMessage "AIè°ƒç”¨", "æ­£åœ¨å¤„ç†æ–°æ¶ˆæ¯..."

    ' è°ƒç”¨Gemini API
    Dim response As String
    response = CallGeminiAPI(config("GEMINI_API_URL"), config("GEMINI_API_KEY"), prompt)

    If response <> "" Then
        ' è§£æå¹¶æ‰§è¡ŒAIå“åº”
        Dim shouldContinue As Boolean
        shouldContinue = ExecuteAIResponse(response, config)

        If Not shouldContinue Then
            LogMessage "AIå†³å®š", "ç»“æŸå¯¹è¯"
        End If
    Else
        LogMessage "é”™è¯¯", "AIè°ƒç”¨å¤±è´¥"
    End If
End Sub

' æ‰§è¡ŒAIå“åº”
Private Function ExecuteAIResponse(response As String, config As Object) As Boolean
    ExecuteAIResponse = True ' é»˜è®¤ç»§ç»­

    ' è§£æcandidatesæ•°ç»„
    Dim partsStartPos As Long, partsEndPos As Long
    partsStartPos = InStr(response, """parts"":")
    If partsStartPos = 0 Then Exit Function

    partsStartPos = InStr(partsStartPos, response, "[")
    If partsStartPos = 0 Then Exit Function

    partsEndPos = FindMatchingBracket(response, partsStartPos, "[", "]")
    If partsEndPos = 0 Then Exit Function

    Dim partsJson As String
    partsJson = Mid(response, partsStartPos, partsEndPos - partsStartPos + 1)

    ' å¤„ç†æ¯ä¸ªpart
    Dim hasEndCall As Boolean
    hasEndCall = ProcessResponseParts(partsJson, config)

    If hasEndCall Then
        ExecuteAIResponse = False
    End If
End Function

' å¤„ç†å“åº”parts
Private Function ProcessResponseParts(partsJson As String, config As Object) As Boolean
    Dim hasEndCall As Boolean
    hasEndCall = False

    ' ç®€åŒ–å¤„ç†ï¼šæŸ¥æ‰¾æ‰€æœ‰functionCall
    Dim pos As Long
    pos = 1

    Do
        Dim functionCallPos As Long
        functionCallPos = InStr(pos, partsJson, """functionCall"":")

        If functionCallPos = 0 Then
            ' æ£€æŸ¥æ˜¯å¦æœ‰textå†…å®¹
            Dim textPos As Long
            textPos = InStr(pos, partsJson, """text"":")
            If textPos > 0 Then
                Dim textContent As String
                textContent = ExtractTextContent(partsJson, textPos)
                If textContent <> "" Then
                    LogMessage "AIæ–‡æœ¬", textContent
                    SendMessage config("NAPCAT_URL"), config("GROUP_ID"), textContent
                End If
            End If
            Exit Do
        End If

        ' æå–å‡½æ•°è°ƒç”¨
        Dim functionName As String, functionArgs As String
        functionName = ExtractFunctionName(partsJson, functionCallPos)
        functionArgs = ExtractFunctionArgs(partsJson, functionCallPos)

        Select Case functionName
            Case "send_group_message"
                Dim message As String
                message = GetJsonValue(functionArgs, "message")
                If message <> "" Then
                    LogMessage "å‘é€æ¶ˆæ¯", message
                    SendMessage config("NAPCAT_URL"), config("GROUP_ID"), message
                End If

            Case "end"
                Dim reason As String
                reason = GetJsonValue(functionArgs, "reason")
                If reason = "" Then reason = "å®Œæˆ"
                LogMessage "ç»“æŸå¯¹è¯", reason
                hasEndCall = True
        End Select

        pos = functionCallPos + 1
    Loop While pos < Len(partsJson)

    ProcessResponseParts = hasEndCall
End Function

' æå–å‡½æ•°å
Private Function ExtractFunctionName(json As String, startPos As Long) As String
    Dim namePos As Long
    namePos = InStr(startPos, json, """name"":")
    If namePos > 0 Then
        ExtractFunctionName = GetJsonValue(Mid(json, namePos - 10), "name")
    End If
End Function

' æå–å‡½æ•°å‚æ•°
Private Function ExtractFunctionArgs(json As String, startPos As Long) As String
    Dim argsPos As Long
    argsPos = InStr(startPos, json, """args"":")
    If argsPos > 0 Then
        ' æŸ¥æ‰¾argså¯¹è±¡çš„å¼€å§‹å’Œç»“æŸ
        Dim objStart As Long, objEnd As Long
        objStart = InStr(argsPos, json, "{")
        If objStart > 0 Then
            objEnd = FindMatchingBracket(json, objStart, "{", "}")
            If objEnd > objStart Then
                ExtractFunctionArgs = Mid(json, objStart, objEnd - objStart + 1)
            End If
        End If
    End If
End Function

' æå–æ–‡æœ¬å†…å®¹
Private Function ExtractTextContent(json As String, startPos As Long) As String
    ExtractTextContent = GetJsonValue(Mid(json, startPos - 10), "text")
End Function

' æŸ¥æ‰¾åŒ¹é…çš„æ‹¬å·
Private Function FindMatchingBracket(text As String, startPos As Long, openChar As String, closeChar As String) As Long
    Dim pos As Long, level As Long
    level = 1
    pos = startPos + 1

    Do While pos <= Len(text) And level > 0
        If Mid(text, pos, 1) = openChar Then
            level = level + 1
        ElseIf Mid(text, pos, 1) = closeChar Then
            level = level - 1
        End If
        pos = pos + 1
    Loop

    If level = 0 Then
        FindMatchingBracket = pos - 1
    Else
        FindMatchingBracket = 0
    End If
End Function

' ===== æ¨¡å—5: BotController =====
' å®šæ—¶å¾ªç¯æ§åˆ¶æ¨¡å—

Option Explicit

Private botRunning As Boolean
Private nextScheduledTime As Date

' å¯åŠ¨æœºå™¨äºº
Public Sub StartBot()
    If botRunning Then
        LogMessage "çŠ¶æ€", "æœºå™¨äººå·²ç»åœ¨è¿è¡Œä¸­"
        Exit Sub
    End If

    botRunning = True
    InitializeLastMessageTime ' åˆå§‹åŒ–æ¶ˆæ¯æ—¶é—´æˆ³

    LogMessage "å¯åŠ¨", "QQæœºå™¨äººå¯åŠ¨"
    UpdateBotStatus "è¿è¡Œä¸­"

    ' ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡
    BotMainLoop
End Sub

' åœæ­¢æœºå™¨äºº
Public Sub StopBot()
    If Not botRunning Then
        LogMessage "çŠ¶æ€", "æœºå™¨äººå·²ç»åœæ­¢"
        Exit Sub
    End If

    botRunning = False

    ' å–æ¶ˆå®šæ—¶ä»»åŠ¡
    On Error Resume Next
    Application.OnTime nextScheduledTime, "BotMainLoop", , False
    On Error GoTo 0

    LogMessage "åœæ­¢", "QQæœºå™¨äººå·²åœæ­¢"
    UpdateBotStatus "å·²åœæ­¢"
End Sub

' ä¸»å¾ªç¯å‡½æ•°
Public Sub BotMainLoop()
    ' æ£€æŸ¥è¿è¡ŒçŠ¶æ€
    If Not botRunning Then Exit Sub

    On Error GoTo ErrorHandler

    ' å¤„ç†æ¶ˆæ¯
    ProcessNewMessages

    ' è°ƒåº¦ä¸‹æ¬¡æ‰§è¡Œï¼ˆ5ç§’åï¼‰
    If botRunning Then
        nextScheduledTime = Now + TimeValue("00:00:05")
        Application.OnTime nextScheduledTime, "BotMainLoop"
    End If

    Exit Sub

ErrorHandler:
    LogMessage "é”™è¯¯", "ä¸»å¾ªç¯å¼‚å¸¸: " & Err.Description

    ' å¦‚æœå‡ºé”™ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´åé‡è¯•ï¼ˆ10ç§’ï¼‰
    If botRunning Then
        nextScheduledTime = Now + TimeValue("00:00:10")
        Application.OnTime nextScheduledTime, "BotMainLoop"
    End If
End Sub

' è·å–æœºå™¨äººçŠ¶æ€
Public Function IsBotRunning() As Boolean
    IsBotRunning = botRunning
End Function

' æ›´æ–°çŠ¶æ€æ˜¾ç¤º
Private Sub UpdateBotStatus(status As String)
    On Error Resume Next
    Worksheets("Config").Range("C8").Value = status
    Worksheets("Config").Range("C8").Interior.Color = IIf(botRunning, RGB(144, 238, 144), RGB(255, 182, 193))
    On Error GoTo 0
End Sub

' å¼ºåˆ¶åœæ­¢ï¼ˆç´§æ€¥ç”¨ï¼‰
Public Sub ForceStopBot()
    botRunning = False
    On Error Resume Next
    Application.OnTime nextScheduledTime, "BotMainLoop", , False
    On Error GoTo 0
    LogMessage "ç´§æ€¥åœæ­¢", "å¼ºåˆ¶åœæ­¢æœºå™¨äºº"
    UpdateBotStatus "å¼ºåˆ¶åœæ­¢"
End Sub

' é‡å¯æœºå™¨äºº
Public Sub RestartBot()
    StopBot
    Application.Wait Now + TimeValue("00:00:02") ' ç­‰å¾…2ç§’
    StartBot
End Sub

' ===== æ¨¡å—6: ConfigManager =====
' é…ç½®å’Œæ—¥å¿—ç®¡ç†æ¨¡å—

Option Explicit

' è·å–æ‰€æœ‰é…ç½®
Public Function GetConfig() As Object
    Dim config As Object
    Set config = CreateObject("Scripting.Dictionary")

    Dim ws As Worksheet
    Set ws = Worksheets("Config")

    config.Add "NAPCAT_URL", ws.Range("B2").Value
    config.Add "GEMINI_API_KEY", ws.Range("B3").Value
    config.Add "GEMINI_API_URL", ws.Range("B7").Value
    config.Add "GROUP_ID", ws.Range("B4").Value
    config.Add "BOT_QQ", ws.Range("B5").Value
    config.Add "POLL_INTERVAL", ws.Range("B6").Value

    Set GetConfig = config
End Function

' è·å–å•ä¸ªé…ç½®å€¼
Public Function GetConfigValue(key As String, defaultValue As Variant) As Variant
    Dim ws As Worksheet
    Set ws = Worksheets("Config")

    Select Case key
        Case "NAPCAT_URL": GetConfigValue = ws.Range("B2").Value
        Case "GEMINI_API_KEY": GetConfigValue = ws.Range("B3").Value
        Case "GROUP_ID": GetConfigValue = ws.Range("B4").Value
        Case "BOT_QQ": GetConfigValue = ws.Range("B5").Value
        Case "POLL_INTERVAL": GetConfigValue = ws.Range("B6").Value
        Case "GEMINI_API_URL": GetConfigValue = ws.Range("B7").Value
        Case "LAST_MESSAGE_TIME": GetConfigValue = ws.Range("B8").Value
        Case Else: GetConfigValue = defaultValue
    End Select

    If IsEmpty(GetConfigValue) Then GetConfigValue = defaultValue
End Function

' ä¿å­˜é…ç½®å€¼
Public Sub SaveConfigValue(key As String, value As Variant)
    Dim ws As Worksheet
    Set ws = Worksheets("Config")

    Select Case key
        Case "LAST_MESSAGE_TIME": ws.Range("B8").Value = value
    End Select
End Sub

' æ—¥å¿—è®°å½•
Public Sub LogMessage(eventType As String, message As String)
    Dim ws As Worksheet
    Set ws = Worksheets("Log")

    ' æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºè¡Œ
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row + 1

    ' è®°å½•æ—¥å¿—
    ws.Cells(lastRow, 1).Value = Now
    ws.Cells(lastRow, 2).Value = eventType
    ws.Cells(lastRow, 3).Value = message

    ' è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
    ws.Cells(lastRow, 1).Select

    ' é™åˆ¶æ—¥å¿—è¡Œæ•°ï¼ˆä¿æŒæœ€æ–°1000è¡Œï¼‰
    If lastRow > 1000 Then
        ws.Rows("2:500").Delete
    End If
End Sub

' ===== æ¨¡å—7: ThisWorkbook =====
' å·¥ä½œç°¿åˆå§‹åŒ–æ¨¡å—

Option Explicit

Private Sub Workbook_Open()
    ' åˆå§‹åŒ–å·¥ä½œè¡¨
    Call InitializeWorksheets

    ' æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
    LogMessage "ç³»ç»Ÿ", "QQæœºå™¨äººExcelç‰ˆæœ¬å·²åŠ è½½"
End Sub

Private Sub Workbook_BeforeClose(Cancel As Boolean)
    ' ç¡®ä¿æœºå™¨äººåœæ­¢
    If IsBotRunning() Then
        StopBot
    End If
End Sub

' åˆå§‹åŒ–æ‰€æœ‰å·¥ä½œè¡¨
Public Sub InitializeWorksheets()
    ' ç¡®ä¿å·¥ä½œè¡¨å­˜åœ¨
    Call EnsureWorksheetExists("Config")
    Call EnsureWorksheetExists("Log")
    Call EnsureWorksheetExists("Messages")

    ' è®¾ç½®å·¥ä½œè¡¨
    Call SetupConfigWorksheet
    Call SetupLogWorksheet
    Call SetupMessagesWorksheet
End Sub

Private Sub EnsureWorksheetExists(sheetName As String)
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = Worksheets(sheetName)
    On Error GoTo 0

    If ws Is Nothing Then
        Set ws = Worksheets.Add
        ws.Name = sheetName
    End If
End Sub

Private Sub SetupConfigWorksheet()
    Dim ws As Worksheet
    Set ws = Worksheets("Config")

    With ws
        .Cells.Clear

        ' è®¾ç½®é…ç½®é¡¹
        .Range("A1").Value = "é…ç½®é¡¹"
        .Range("B1").Value = "å€¼"
        .Range("A2").Value = "NAPCAT_URL"
        .Range("B2").Value = "http://localhost:3000"
        .Range("A3").Value = "GEMINI_API_KEY"
        .Range("B3").Value = ""
        .Range("A4").Value = "GROUP_ID"
        .Range("B4").Value = ""
        .Range("A5").Value = "BOT_QQ"
        .Range("B5").Value = ""
        .Range("A6").Value = "POLL_INTERVAL"
        .Range("B6").Value = "5"
        .Range("A7").Value = "GEMINI_API_URL"
        .Range("B7").Value = ""
        .Range("A8").Value = "LAST_MESSAGE_TIME"
        .Range("B8").Value = "0"

        ' æ·»åŠ æ§åˆ¶é¢æ¿
        .Range("A10").Value = "æ§åˆ¶é¢æ¿:"
        .Range("C8").Value = "çŠ¶æ€: å·²åœæ­¢"

        ' æ ¼å¼åŒ–
        .Range("A1:B1").Font.Bold = True
        .Range("A1:B1").Interior.Color = RGB(200, 200, 255)
        .Columns("A:A").ColumnWidth = 20
        .Columns("B:B").ColumnWidth = 50
        .Columns("C:C").ColumnWidth = 15
    End With
End Sub

Private Sub SetupLogWorksheet()
    Dim ws As Worksheet
    Set ws = Worksheets("Log")

    With ws
        .Cells.Clear
        .Range("A1").Value = "æ—¶é—´"
        .Range("B1").Value = "äº‹ä»¶ç±»å‹"
        .Range("C1").Value = "è¯¦ç»†ä¿¡æ¯"

        ' æ ¼å¼åŒ–è¡¨å¤´
        .Range("A1:C1").Font.Bold = True
        .Range("A1:C1").Interior.Color = RGB(200, 255, 200)
        .Columns("A:A").ColumnWidth = 20
        .Columns("B:B").ColumnWidth = 15
        .Columns("C:C").ColumnWidth = 60
    End With
End Sub

Private Sub SetupMessagesWorksheet()
    Dim ws As Worksheet
    Set ws = Worksheets("Messages")

    With ws
        .Cells.Clear
        .Range("A1").Value = "æ—¶é—´æˆ³"
        .Range("B1").Value = "ç”¨æˆ·ID"
        .Range("C1").Value = "æ¶ˆæ¯å†…å®¹"
        .Range("D1").Value = "AIå“åº”"

        ' æ ¼å¼åŒ–è¡¨å¤´
        .Range("A1:D1").Font.Bold = True
        .Range("A1:D1").Interior.Color = RGB(255, 255, 200)
        .Columns("A:A").ColumnWidth = 20
        .Columns("B:B").ColumnWidth = 15
        .Columns("C:C").ColumnWidth = 40
        .Columns("D:D").ColumnWidth = 40
    End With
End Sub

' ===== ä½¿ç”¨è¯´æ˜ =====
'
' 1. åˆ›å»ºæ–°Excelæ–‡ä»¶ï¼Œå¦å­˜ä¸º .xlsm æ ¼å¼
' 2. Alt+F11 æ‰“å¼€VBAç¼–è¾‘å™¨
' 3. åˆ†åˆ«åˆ›å»ºä»¥ä¸Š7ä¸ªæ¨¡å—ï¼Œå¤åˆ¶å¯¹åº”ä»£ç 
' 4. åœ¨Configå·¥ä½œè¡¨æ·»åŠ 3ä¸ªæŒ‰é’®ï¼š
'    - å¯åŠ¨æŒ‰é’®ï¼šæŒ‡å®šå® StartBot
'    - åœæ­¢æŒ‰é’®ï¼šæŒ‡å®šå® StopBot
'    - é‡å¯æŒ‰é’®ï¼šæŒ‡å®šå® RestartBot
' 5. ä¿®æ”¹Configå·¥ä½œè¡¨ä¸­çš„APIå¯†é’¥å’ŒQQé…ç½®
' 6. ç¡®ä¿NapCatè¿è¡Œåœ¨localhost:3000
' 7. ç‚¹å‡»å¯åŠ¨æŒ‰é’®å¼€å§‹è¿è¡Œ
'
' åŠŸèƒ½ç‰¹æ€§ï¼š
' - å®Œå…¨å¤åˆ¶shellè„šæœ¬åŠŸèƒ½
' - å›¾å½¢åŒ–ç•Œé¢å’Œå®æ—¶æ—¥å¿—
' - éé˜»å¡è¿è¡Œï¼ŒExcelä»å¯æ­£å¸¸ä½¿ç”¨
' - é…ç½®çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯
' - æ›´å¥½çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ˜¾ç¤º
'